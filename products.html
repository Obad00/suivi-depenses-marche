<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produits du Jour</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    

    <style>
        .carte {
            padding: 10px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            gap: 10px; /* Augmente l'espace entre les cartes */
        }

        button {
            flex: 1; /* Assure que les boutons prennent une largeur égale */
        }

        .product-price {
            font-weight: bold;
        }

        .my-4 {
            text-align: center;
        }
        .background-purchased {
        background-color: #304FFE; /* Couleur bleue pour les produits achetés */
        color: white;
            }

            .background-not-purchased {
                background-color: #F8B319; /* Couleur orange pour les produits non achetés */
                color: white;
            }

            .product-item {
                transition: background-color 0.3s ease;
            }

            .fixed-bottom {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                border-top-left-radius: 30px;
                border-top-right-radius: 30px;
                background-color: #304FFE; /* Couleur de fond pour le menu */
                color: white;
                z-index: 50; /* Assure que le menu est au-dessus du contenu */
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2); /* Ombre pour l'effet flottant */
            }

            .container {
                padding-bottom: 80px; /* Ajustez cette valeur en fonction de la hauteur de votre menu fixe */
            }


        .fixed-bottom .icon-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px;
        }

        .fixed-bottom .icon-container div {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .fixed-bottom .icon-container div i {
            font-size: 24px; /* Taille des icônes */
        }

        .ml {
            margin-left: 10px;
        }
        .flex {
            padding: 5px;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div class="container mx-auto">
        <a class="ml" href="loading.html"><  <span class="ml-1 font-bold text-lg">Retour</span></a>

        <header class="my-4">

            <h1 class="text-2xl font-bold">Produits du <span id="date-header"></span></h1>
            <div class="carte">
                <button id="purchased" style="background-color: #304FFE; color: white;" class="px-4 py-2 rounded">Produits <br>Achetés</button>
                <button id="not-purchased" style="background-color: #F8B319; color: white;" class="px-4 py-2 rounded">Produits <br> Non Achetés</button>
            </div>
        </header>
        <main id="product-list-container">
            <!-- Les produits seront insérés ici -->
            <div class="min-w-xl mx-auto md:max-w-lg p-10">
                <ul class="flex flex-col gap-5 text-xl">
                    <!-- Les éléments de la liste seront insérés ici dynamiquement -->
                </ul>
            </div>
        </main>
        <footer class="my-4">
            <p id="total-price" class="text-xl font-bold">Prix Total: 0 Fcfa</p>
        </footer>

     
       <!-- Menu fixe en bas -->
    <div class="fixed-bottom">
        <div class="icon-container">
            <div>
                <i class="fas fa-home"></i> <!-- Icône Accueil -->
                <span>Accueil</span>
            </div>
            <div>
                <i class="fas fa-dollar-sign"></i> <!-- Icône Dépense -->
                <span>Dépense</span>
            </div>
            <div>
                <i class="fas fa-history"></i> <!-- Icône Historique -->
                <span>Historique</span>
            </div>
            <div>
                <i class="fas fa-user"></i> <!-- Icône Profil -->
                <span>Profil</span>
            </div>
        </div>
    </div>

    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
        
       
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        // Initialisation de Supabase
        const supabaseClient = supabase.createClient('https://grxcjytkisswabnxwzrb.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdyeGNqeXRraXNzd2Fibnh3enJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjEzMjgzODAsImV4cCI6MjAzNjkwNDM4MH0.5t7sGuaiGuYoChM71yWfwH8bxOwmRRjinoCYvXO9v7U');

        document.addEventListener('DOMContentLoaded', async function() {
    const params = new URLSearchParams(window.location.search);
    const dateStr = params.get('date');

    if (!dateStr) {
        console.error('Aucune date spécifiée');
        return;
    }

    const dateParts = dateStr.split('/');
    if (dateParts.length !== 3) {
        console.error('Format de date invalide');
        return;
    }

    // Convertir le format dd/mm/yyyy en yyyy-mm-dd
    const [day, month, year] = dateParts;
    const date = `${year}-${month}-${day}`;
    document.getElementById('date-header').textContent = dateStr;

    const productsList = document.getElementById('product-list-container').querySelector('ul');
    const btnPurchased = document.getElementById('purchased');
    const btnNotPurchased = document.getElementById('not-purchased');
    const totalPriceElement = document.getElementById('total-price');

    async function fetchProducts() {
        try {
            const startDate = new Date(date);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(date);
            endDate.setHours(23, 59, 59, 999);

            const { data: products, error } = await supabaseClient
                .from('products')
                .select('*')
                .gte('planned_date', startDate.toISOString())
                .lte('planned_date', endDate.toISOString());

            if (error) {
                throw error;
            }

            productsList.innerHTML = '';

            if (products.length === 0) {
                productsList.innerHTML = '<p>Aucun produit trouvé.</p>';
                totalPriceElement.textContent = 'Prix Total: 0 Fcfa';
                return;
            }

            products.forEach(product => {
                const listItem = document.createElement('li');
                listItem.className = 'border-b border-black rounded-sm px-4 py-2 flex items-center justify-between';
                listItem.dataset.purchased = product.purchased;
                listItem.dataset.id = product.id; // Ajouter l'ID du produit pour la suppression

                // Calculer le prix total pour chaque produit
                const productTotalPrice = product.quantity * product.price;

                listItem.innerHTML = `
                    <span class="flex-1">${product.name} - ${product.quantity} x ${product.price} Fcfa</span>
                    <div class="flex items-center space-x-2">
                        <span class="product-price">${productTotalPrice} Fcfa</span>

                       <button class="text-black-500 hover:text-blue-700" aria-label="Modifier le statut">
                        <i class="fa-solid fa-cart-plus w-6 h-6 text-current"></i>
                      </button>


                       <button class="text-red-500 hover:text-red-700" aria-label="Supprimer">
                        <i class="fa-solid fa-trash-can w-6 h-6 text-current"></i>
                      </button>

                    </div>
                `;
                productsList.appendChild(listItem);
            });

            // Mettre à jour le prix total
            updateTotalPrice();

            // Ajouter les gestionnaires d'événements
            addEventListeners();
        } catch (error) {
            console.error('Erreur lors de la récupération des produits:', error.message);
        }
    }

    function addEventListeners() {
        // Ajouter les gestionnaires d'événements pour les icônes
        document.querySelectorAll('button[aria-label="Modifier le statut"]').forEach(button => {
            button.addEventListener('click', async function(event) {
                const listItem = event.target.closest('li');
                const id = listItem.dataset.id;
                const isPurchased = listItem.dataset.purchased === 'true';

                // Modifier le statut du produit
                const { error } = await supabaseClient
                    .from('products')
                    .update({ purchased: !isPurchased })
                    .eq('id', id);

                if (error) {
                    console.error('Erreur lors de la mise à jour du produit:', error.message);
                    return;
                }

                // Mettre à jour l'affichage
                listItem.dataset.purchased = !isPurchased;
                listItem.style.display = isPurchased ? 'none' : 'flex';

                // Recalculer le prix total
                updateTotalPrice();
            });
        });

        document.querySelectorAll('button[aria-label="Supprimer"]').forEach(button => {
            button.addEventListener('click', async function(event) {
                const listItem = event.target.closest('li');
                const id = listItem.dataset.id;

                // Supprimer le produit
                const { error } = await supabaseClient
                    .from('products')
                    .delete()
                    .eq('id', id);

                if (error) {
                    console.error('Erreur lors de la suppression du produit:', error.message);
                    return;
                }

                // Retirer l'élément de la liste
                listItem.remove();

                // Recalculer le prix total
                updateTotalPrice();
            });
        });

        // Ajouter les gestionnaires d'événements pour les boutons d'affichage
        btnPurchased.addEventListener('click', function() {
            document.querySelectorAll('li').forEach(item => {
                if (item.dataset.purchased === 'true') {
                    item.style.display = 'flex';
                    item.classList.add('background-purchased');
                    item.classList.remove('background-not-purchased');
                } else {
                    item.style.display = 'none';
                }
            });
            updateTotalPrice(); // Mettre à jour le prix total après filtrage
        });

        btnNotPurchased.addEventListener('click', function() {
            document.querySelectorAll('li').forEach(item => {
                if (item.dataset.purchased === 'false') {
                    item.style.display = 'flex';
                    item.classList.add('background-not-purchased');
                    item.classList.remove('background-purchased');
                } else {
                    item.style.display = 'none';
                }
            });
            updateTotalPrice(); // Mettre à jour le prix total après filtrage
        });
    }

    function updateTotalPrice() {
        let totalPrice = 0;
        document.querySelectorAll('li').forEach(item => {
            if (item.style.display !== 'none') {
                const price = parseFloat(item.querySelector('.product-price').textContent.replace(' Fcfa', ''));
                totalPrice += price;
            }
        });
        totalPriceElement.textContent = `Prix Total: ${totalPrice} Fcfa`;
    }

    // Initialiser la liste des produits
    fetchProducts();
});

    </script>
</body>
</html>
